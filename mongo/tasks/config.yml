---

 - name: change the port
   include_vars: vars/config

 - name: create a template
   template: src=mongod.j2 dest=/etc/mongod.conf owner=root group=root

 - name: send the script
   template: src=script-c.j2 dest=/home/ubuntu/script.sh mode=555 
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: run the initilization command
   command: mongod --config /etc/mongod.conf --fork

 - name: run the script
   command: sh /home/ubuntu/script.sh
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: run the script
   file: path=/home/ubuntu/script.sh state=absent
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: send the replica set script
   copy: src=rs.sh dest=/home/ubuntu/ mode=0555
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: send the replica set script
   copy: src=rs.sh dest=/home/ubuntu/ mode=0777
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: add the replica sets in the file rs.sh
   lineinfile:
        dest: /home/ubuntu/rs.sh
        line: "mongo --port 27019 --eval 'rs.add( { host: \"{{ item }}:27019\", priority: 0, votes: 0 } )'"
        state: present
   with_items: "{{groups['config']}}"
   when: "'{{ cnf_0 }}' in inventory_hostname"

 - name: run the script
   command: sh /home/ubuntu/rs.sh
   when: "'{{ cnf_0 }}' in inventory_hostname"


 - name: delete the script
   file: path=/home/ubuntu/rs.sh state=absent
   when: "'{{ cnf_0 }}' in inventory_hostname"
